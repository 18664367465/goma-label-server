!function(e,a){"object"==typeof exports&&"object"==typeof module?module.exports=a():"function"==typeof define&&define.amd?define([],a):"object"==typeof exports?exports.goma=a():e.goma=a()}(window,function(){return function(e){var a={};function t(n){if(a[n])return a[n].exports;var l=a[n]={i:n,l:!1,exports:{}};return e[n].call(l.exports,l,l.exports,t),l.l=!0,l.exports}return t.m=e,t.c=a,t.d=function(e,a,n){t.o(e,a)||Object.defineProperty(e,a,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,a){if(1&a&&(e=t(e)),8&a)return e;if(4&a&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&a&&"string"!=typeof e)for(var l in e)t.d(n,l,function(a){return e[a]}.bind(null,l));return n},t.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(a,"a",a),a},t.o=function(e,a){return Object.prototype.hasOwnProperty.call(e,a)},t.p="",t(t.s=4)}([function(e,a,t){"use strict";t.r(a),t.d(a,"ajax",function(){return n}),t.d(a,"getImageBySrc",function(){return l}),t.d(a,"readFile",function(){return r}),t.d(a,"readLabelFile",function(){return i}),t.d(a,"readSourceFile",function(){return o}),t.d(a,"readdir",function(){return s});let n=(e,a,t)=>{let n=new XMLHttpRequest;n.responseType="json",n.onreadystatechange=function(){200==n.status&&4==n.readyState&&t&&t(n)},a?n.open("POST",e,!0):n.open("GET",e,!0),n.send(a)},l=(e,a)=>{var t=new Image;t.src=e,t.onload=function(){a&&a(this)}},r=(e,a,t)=>{n("/api/readfile/"+(e=e||"")+"/"+(a=a||""),null,function(e){t&&t(e.response)})},i=(e,a)=>{r("label",e,function(e){a&&a(e)})},o=(e,a)=>{r("source",e,function(e){a&&a(e)})},s=(e,a)=>{"source"==e||"label"==e?n("/api/readdir/"+e,null,function(e){a&&a(e.response)}):a&&a(null)}},function(e,a,t){},,,function(e,a,t){"use strict";t.r(a);t(1);var n=t(0);var l={sourceFiles:null,activeShape:null,labelInfo:{imagePath:null,baseName:null,imageData:null,shapes:[],imageWidth:null,imageHeight:null},currentLabel:null,isDrawing:!1,isMouseDown:!1};var r,i={appEl:document.querySelector("#app"),sourceImgEl:document.createElement("img"),maskImgEl:document.querySelector("#maskImg"),imgCanvasEl:(r=document.querySelector("#imgCanvas"),l.imgCtx=r.getContext("2d"),r),labelCanvasEl:function(){var e=document.querySelector("#labelCanvas");return l.labelCtx=e.getContext("2d"),e}(),cacheCanvasEl:function(){var e=document.createElement("canvas");return l.cacheCtx=e.getContext("2d"),e}(),magnifierCanvasEl:function(){var e=document.querySelector("#magnifierCanvas");return l.magnifierCtx=e.getContext("2d"),e}(),canvasWrapEl:document.querySelector("#canvasWrap"),labelImagesWrapEl:document.querySelector("#labelImagesWrap"),fileWrapEl:document.querySelector("#fileWrap")};const o={unSeelctLabel:function(){l.activeShape=null;var e=i.labelImagesWrapEl.querySelector(".labelImage.active");e&&e.classList.remove("active")},getSourceImg:function(e){n.getImageBySrc(l.labelInfo.imageData,function(a){l.labelInfo.imageWidth=a.width,l.labelInfo.imageHeight=a.height,e&&e(a)})},startDraw:function(e){o.unSeelctLabel(),l.isDrawing=!0,l.currentLabel={left:e.x,top:e.y,width:0,height:0,timestamp:(new Date).valueOf(),points:[[e.x,e.y],[e.x,e.y]],imageData:null},l.labelInfo.shapes.push(l.currentLabel),o.renderLabelCanvas(),o.renderCurrentLabelExplore(l.currentLabel)},addPoint:function(e){var a=l.currentLabel.points;2==a.length&&a[0][0]==e.x&&a[0][1]==e.y||(a[a.length-1]=[e.x,e.y],l.currentLabel.points.push([e.x,e.y]),o.calcCurrentLabeldimension(),o.renderLabelCanvas(),o.renderCurrentLabelExplore(l.currentLabel))},calcCurrentLabeldimension:function(){if(l.currentLabel){var e=l.currentLabel,a=e.points;if(!(a.length<=3)){var t=[],n=[];a.map(function(e,a){t.push(e[0]),n.push(e[1])});var r=e.left=Math.min.apply(null,t),o=e.top=Math.min.apply(null,n),s=i.cacheCanvasEl.width=e.width=Math.max.apply(null,t)-r,c=i.cacheCanvasEl.height=e.height=Math.max.apply(null,n)-o;l.cacheCtx.clearRect(0,0,s,c);var u=l.imgCtx.getImageData(r,o,s,c);l.cacheCtx.putImageData(u,0,0),e.imageData=i.cacheCanvasEl.toDataURL()}}},getMaskImageData:function(){},uploadData:function(){for(var e=l.labelInfo.shapes,a=0;a<e.length;a++){e[a].label=a+""}console.log(e);let t=JSON.stringify(l.labelInfo),r=new FormData;r.append("data",t),r.append("imagePath",l.labelInfo.imagePath),n.ajax("/api/writefile/label",r,function(e){e.response.filename}),o.getMaskImageData()},stopDraw:function(){if(l.isDrawing){var e=l.currentLabel,a=e.points;if(a.length<=3){l.labelInfo.shapes.splice(l.labelInfo.shapes.indexOf(e),1);var t=i.labelImagesWrapEl.querySelector("#label_"+e.timestamp);t&&t.parentNode.removeChild(t),o.renderLabelCanvas()}else a.splice(a.length-1,1),o.renderLabelCanvas(),o.uploadData();l.currentLabel=null,l.isDrawing=!1}},unDoDraw:function(){if(l.isDrawing){var e=l.currentLabel.points;e.length<=2||(e.splice(e.length-2,1),o.renderLabelCanvas())}},renderImgCanvas:function(e){var a=l.imgCtx;a.save(),a.clearRect(0,0,a.canvas.width,a.canvas.height),a.drawImage(e,0,0),a.restore()},renderAllLabelExplore:function(){var e="";l.labelInfo.shapes.forEach(function(a,t){e+='<div data-feat="selectLabel" data-label-timestamp="'+a.timestamp+'" class="labelImage" id="label_'+a.timestamp+'"><div class="label-img-wrap"><img src="'+a.imageData+'"/></div><div class="label-name" data-feat="showInput"><span>'+(a.name||"未命名")+'</span></div><div data-feat="deleteLabel" class="delete-label"><svg width="14" height="14" viewBox="0 0 20 20"><path fill="#000000" d="M15.5 2h-3.5v-0.5c0-0.827-0.673-1.5-1.5-1.5h-2c-0.827 0-1.5 0.673-1.5 1.5v0.5h-3.5c-0.827 0-1.5 0.673-1.5 1.5v1c0 0.652 0.418 1.208 1 1.414v12.586c0 0.827 0.673 1.5 1.5 1.5h10c0.827 0 1.5-0.673 1.5-1.5v-12.586c0.582-0.206 1-0.762 1-1.414v-1c0-0.827-0.673-1.5-1.5-1.5zM8 1.5c0-0.276 0.224-0.5 0.5-0.5h2c0.276 0 0.5 0.224 0.5 0.5v0.5h-3v-0.5zM14.5 19h-10c-0.276 0-0.5-0.224-0.5-0.5v-12.5h11v12.5c0 0.276-0.224 0.5-0.5 0.5zM16 4.5c0 0.276-0.224 0.5-0.5 0.5h-12c-0.276 0-0.5-0.224-0.5-0.5v-1c0-0.276 0.224-0.5 0.5-0.5h12c0.276 0 0.5 0.224 0.5 0.5v1z"></path><path fill="#000000" d="M12.5 7c-0.276 0-0.5 0.224-0.5 0.5v10c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-10c0-0.276-0.224-0.5-0.5-0.5z"></path><path fill="#000000" d="M9.5 7c-0.276 0-0.5 0.224-0.5 0.5v10c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-10c0-0.276-0.224-0.5-0.5-0.5z"></path><path fill="#000000" d="M6.5 7c-0.276 0-0.5 0.224-0.5 0.5v10c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-10c0-0.276-0.224-0.5-0.5-0.5z"></path></svg></div></div>'}),i.labelImagesWrapEl.innerHTML=e},renderCurrentLabelExplore:function(e){if(e){var a=i.labelImagesWrapEl.querySelector("#label_"+e.timestamp);a||((a=document.createElement("div")).setAttribute("data-feat","selectLabel"),a.setAttribute("data-label-timestamp",e.timestamp),a.classList.add("labelImage"),a.setAttribute("id","label_"+e.timestamp),a.innerHTML='<div class="label-img-wrap"></div><div data-feat="showInput" class="label-name"><span>'+(e.name||"未命名")+'</span></div><div data-feat="deleteLabel" class="delete-label"><svg width="14" height="14" viewBox="0 0 20 20"><path fill="#000000" d="M15.5 2h-3.5v-0.5c0-0.827-0.673-1.5-1.5-1.5h-2c-0.827 0-1.5 0.673-1.5 1.5v0.5h-3.5c-0.827 0-1.5 0.673-1.5 1.5v1c0 0.652 0.418 1.208 1 1.414v12.586c0 0.827 0.673 1.5 1.5 1.5h10c0.827 0 1.5-0.673 1.5-1.5v-12.586c0.582-0.206 1-0.762 1-1.414v-1c0-0.827-0.673-1.5-1.5-1.5zM8 1.5c0-0.276 0.224-0.5 0.5-0.5h2c0.276 0 0.5 0.224 0.5 0.5v0.5h-3v-0.5zM14.5 19h-10c-0.276 0-0.5-0.224-0.5-0.5v-12.5h11v12.5c0 0.276-0.224 0.5-0.5 0.5zM16 4.5c0 0.276-0.224 0.5-0.5 0.5h-12c-0.276 0-0.5-0.224-0.5-0.5v-1c0-0.276 0.224-0.5 0.5-0.5h12c0.276 0 0.5 0.224 0.5 0.5v1z"></path><path fill="#000000" d="M12.5 7c-0.276 0-0.5 0.224-0.5 0.5v10c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-10c0-0.276-0.224-0.5-0.5-0.5z"></path><path fill="#000000" d="M9.5 7c-0.276 0-0.5 0.224-0.5 0.5v10c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-10c0-0.276-0.224-0.5-0.5-0.5z"></path><path fill="#000000" d="M6.5 7c-0.276 0-0.5 0.224-0.5 0.5v10c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-10c0-0.276-0.224-0.5-0.5-0.5z"></path></svg></div>',i.labelImagesWrapEl.appendChild(a)),e.imageData&&n.getImageBySrc(e.imageData,function(t){var n=i.cacheCanvasEl,r=l.cacheCtx,o=e.points;r.save(),n.width=e.width,n.height=e.height,r.clearRect(0,0,n.width,n.height),r.beginPath();for(var s=0;s<o.length;s++){var c=o[s],u=c[0]-e.left,p=c[1]-e.top;0!=s?r.lineTo(u,p):r.moveTo(u,p)}r.closePath(),r.clip(),r.drawImage(t,0,0),r.restore();var d=n.toDataURL();(t=a.querySelector(".label-img-wrap").querySelector("img"))?a.querySelector("img").src=d:t=a.querySelector(".label-img-wrap").innerHTML='<img src="'+d+'"/>',e.imageData=d})}},renderLabelCanvas:function(){var e=l.labelCtx;e.clearRect(0,0,e.canvas.width,e.canvas.height),e.save(),e.lineWidth=1,e.lineJoin="round",e.fillStyle="hsla(60, 100%, 50%, .1)",e.strokeStyle="hsla(60, 100%, 50%, 1)";for(var a=l.labelInfo.shapes,t=0;t<a.length;t++){var n=a[t];e.save(),l.activeShape&&l.activeShape===n&&(e.lineWidth=2,e.strokeStyle="hsla(0, 100%, 60%, 1)",e.fillStyle="hsla(0, 100%, 50%, .2)");var r=n.points;e.beginPath();for(var i=0;i<r.length;i++){var o=r[i];0==i?e.moveTo(o[0],o[1]):e.lineTo(o[0],o[1])}e.closePath(),e.fill(),e.stroke(),e.restore()}e.restore()},resetAllCanvasSize:function(e){var a=l.labelInfo.imageWidth,t=l.labelInfo.imageHeight,n=i.imgCanvasEl,r=i.labelCanvasEl,o=i.canvasWrapEl,s=i.magnifierCanvasEl;n.width=s.width=r.width=a,n.height=s.height=r.height=t,n.style.width=s.style.width=o.style.width=r.style.width=a+"px",n.style.height=s.style.height=o.style.height=r.style.height=t+"px"},clearAllCanvas:function(){l.imgCtx.clearRect(0,0,i.imgCanvasEl.width,i.imgCanvasEl.height),l.labelCtx.clearRect(0,0,i.labelCanvasEl.height,i.labelCanvasEl.height)},initData:function(e){i.labelImagesWrapEl.innerHTML="",n.readLabelFile(l.labelInfo.baseName+".json",function(a){a.data?(l.labelInfo=JSON.parse(a.data),l.labelInfo.baseName=a.filename.split(".")[0],o.getSourceImg(function(a){e&&e(a)})):n.readSourceFile(l.labelInfo.baseName+".jpg",function(a){a.data&&(l.labelInfo.imageData="data:image/jpeg;base64,"+a.data,o.getSourceImg(function(a){l.labelInfo.shapes=[],e&&e(a)}))})})},initView:function(){o.initData(function(e){o.resetAllCanvasSize(),o.clearAllCanvas(),o.renderImgCanvas(e),o.renderLabelCanvas(),o.renderAllLabelExplore(),o.getMaskImageData(),i.canvasWrapEl.classList.add("show")})}};var s=o;const c={registEventHandler:function(){i.canvasWrapEl.addEventListener("mousedown",c.canvasWrapEl__onMouseDown),i.canvasWrapEl.addEventListener("mousemove",c.canvasWrapEl__onMouseMove),i.canvasWrapEl.addEventListener("mouseup",c.canvasWrapEl__onMouseUp),i.canvasWrapEl.addEventListener("contextmenu",c.canvasWrapEl__onContextMenu),i.fileWrapEl.addEventListener("click",c.fileWrapEl_onClick),i.labelImagesWrapEl.addEventListener("click",c.labelImagesWrapEl__onClick),window.addEventListener("keydown",c.window__onKeyDown)},canvasWrapEl__onMouseDown:function(e){e.preventDefault();var a={x:e.offsetX,y:e.offsetY};l.isMouseDown=!0,0==e.button&&(l.isDrawing?s.addPoint(a):s.startDraw(a))},canvasWrapEl__onMouseMove:function(e){e.preventDefault();var a={x:e.offsetX,y:e.offsetY};if(l.isDrawing){var t=l.currentLabel.points;t[t.length-1]=[a.x,a.y],s.renderLabelCanvas()}},canvasWrapEl__onMouseUp:function(e){e.preventDefault(),l.isMouseDown=!0},canvasWrapEl__onContextMenu:function(e){e.preventDefault(),2==e.button&&s.stopDraw()},window__onKeyDown:function(e){var a=e.keyCode||e.which||e.charCode;81==a&&(e.preventDefault(),s.stopDraw()),(e.ctrlKey||e.metaKey&&90==a)&&(e.preventDefault(),s.unDoDraw())},fileWrapEl_onClick:function(e){for(var a=e.target,t={selectFile:function(e,a){var t=a.dataset.filename;t&&(l.labelInfo.imagePath=t,l.labelInfo.baseName=l.labelInfo.imagePath.split(".")[0],i.fileWrapEl.querySelector(".file-name.active").classList.remove("active"),a.classList.add("active"),s.initView())}};a!==this;){if(!a)return;var n=a.dataset.feat;if(!1===(n&&t.hasOwnProperty(n)&&t[n](e,a)))return;a=a.parentNode}},labelImagesWrapEl__onClick:function(e){for(var a=e.target,t={deleteLabel:function(e,a){var t=a.parentNode,n=t.dataset.labelTimestamp;l.labelInfo.shapes.forEach(function(e,a){e.timestamp==n&&(l.labelInfo.shapes.splice(a,1),t.parentNode.removeChild(t),s.renderLabelCanvas(),s.uploadData())})},selectLabel:function(e,a){s.unSeelctLabel();var t=a.dataset.labelTimestamp;a.classList.add("active"),l.labelInfo.shapes.forEach(function(e,a){e.timestamp==t&&(l.activeShape=e,s.renderLabelCanvas())})},showInput:function(e,a){var t=window.prompt("输入标注内容：",a.innerText);if(t){t=(t=t.replace(/^\s+|\s$/g,"")).replace(/</g,"&lt;");var n=a.parentNode.dataset.labelTimestamp;return l.labelInfo.shapes.forEach(function(e,l){e.timestamp==n&&(e.name=t,a.innerText=t)}),s.uploadData(),"stop"}}};a!==this;){if(!a)return;var n=a.dataset.feat;if("stop"===(n&&t.hasOwnProperty(n)&&t[n](e,a)))return;a=a.parentNode}}};var u=c;t.d(a,"label",function(){return p});let p={utils:n,view:i,model:l,controller:s,eventHandler:u}}])});